---
title: "TCGA Breast"
output: html_notebook
---

Load the data previously-extracted from TCGA

```{r eval=FALSE}
library(TCGAbiolinks)
# get clinical data
information.clinical <- GDCquery_clinic(project = "TCGA-BRCA",type = "clinical") 

query <- GDCquery(project = "TCGA-BRCA",
                  data.category = "Clinical",
                  data.type = "Clinical Supplement",
                  data.format = "BCR Biotab")
GDCdownload(query)
clinical.all <- GDCprepare(query)
tcga_brca.clin <- clinical.all$clinical_patient_brca

readr::write_csv(tcga_brca.clin, "tcga_brca.clin.csv")

```


```{r}
library(dplyr)
library(SummarizedExperiment)
load("brcaExp.rda")
subtype <- read.csv('information_subtype.csv')
clin <- read.csv("tcga_brca.clin.csv") %>% 
  select(patient = bcr_patient_barcode,
         er_status_by_ihc,
         her2_status_by_ihc,
         pr_status_by_ihc)


table(data$shortLetterCode)
```

```{r}
set.seed(270624)
rand_t <- sample(which(data$shortLetterCode == "TP"),20)

rand_normal <- sample(which(data$shortLetterCode == "NT"),20)

data <- data[,c(rand_t,rand_normal)]

meta <- colData(data) %>% data.frame %>% 
  select(patient, shortLetterCode) %>% 
  left_join(subtype) %>% 
  select(patient,shortLetterCode,vital_status,age_at_initial_pathologic_diagnosis,BRCA_Subtype_PAM50,pathologic_stage,BRCA_Pathology,days_to_death,days_to_last_followup) %>% left_join(clin)



## find which IDs can be mapped to SYMBOLs

library(org.Hs.eg.db)

df <- data.frame(id = rownames(data)) %>% 
  tidyr::separate(id, into = c("ENSEMBL","Version"),remove = FALSE)

anno <- AnnotationDbi::select(org.Hs.eg.db, 
                              keys = df$ENSEMBL,
                              columns = "SYMBOL",
                              keytype = "ENSEMBL"
                              )

id_to_use <- left_join(df, anno) %>% 
  filter(!is.na(SYMBOL)) %>% 
  pull(id) %>% 
  unique

data <- data[id_to_use,]

counts <- assay(data,"unstranded") %>% data.frame %>% 
  tibble::rownames_to_column("ens") %>% 
  tidyr::separate(ens, into=c("ENSEMBL","V")) %>% 
  dplyr::select(-V) %>% 
  filter(!duplicated(ENSEMBL))

rownames(meta) <- colnames(counts)[-1]
write.table(counts, "brca_example.tsv",sep = "\t")
write.table(meta, "brca_example_meta.tsv", sep = "\t")
```

## Make ESR1 example for ML

```{r}
meta <- read.table("brca_example_meta.tsv")
raw <- read.table("brca_example.tsv")
counts <- raw[,-1]
rownames(counts) <- raw$ENSEMBL
```

```{r}
library(DESeq2)
dds <- DESeqDataSetFromMatrix(counts,
                              meta,
                              ~er_status_by_ihc)
```

```{r}
ids <- data.frame(ens_ids = unique(rownames(dds)))
ids

ens_ids <- ids %>% 
  tidyr::separate(ens_ids, into = c("ENSEMBL","V")) %>% 
  pull(ENSEMBL)

library(org.Hs.eg.db)
anno <- AnnotationDbi::select(org.Hs.eg.db,
                              keys = ens_ids,
                              columns = c("SYMBOL","GENENAME"),
                              keytype = "ENSEMBL")
anno

esr1_id <- filter(anno, SYMBOL == "ESR1") %>% pull(ENSEMBL)
```

```{r}
vsd <- vst(dds)

ESR1_Level = assay(vsd)[grepl(esr1_id, rownames(vsd)),]

df <- data.frame(ESR1_Level, ER_Status = dds$er_status_by_ihc)
df
```

```{r}
ggplot(df, aes(x= ER_Status, y =ESR1_Level)) + geom_boxplot()
```

