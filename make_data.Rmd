---
title: "TCGA Breast"
output: html_notebook
---

Load the data previously-extracted from TCGA

```{r eval=FALSE}
library(TCGAbiolinks)
# get clinical data
information.clinical <- GDCquery_clinic(project = "TCGA-BRCA",type = "clinical") 

query <- GDCquery(project = "TCGA-BRCA",
                  data.category = "Clinical",
                  data.type = "Clinical Supplement",
                  data.format = "BCR Biotab")
GDCdownload(query)
clinical.all <- GDCprepare(query)
tcga_brca.clin <- clinical.all$clinical_patient_brca

readr::write_csv(tcga_brca.clin, "tcga_brca.clin.csv")

```


```{r}
library(dplyr)
library(SummarizedExperiment)
load("brcaExp.rda")
subtype <- read.csv('information_subtype.csv')
clin <- read.csv("tcga_brca.clin.csv") %>% 
  select(patient = bcr_patient_barcode,
         er_status_by_ihc,
         her2_status_by_ihc,
         pr_status_by_ihc)
data@colData %>% data.frame %>% View

table(data$shortLetterCode)
```

```{r}
set.seed(270624)
rand_tumours <- sample(which(data$shortLetterCode == "TP"),50)

rand_normal <- sample(which(data$shortLetterCode == "NT"),50)

data <- data[,c(rand_tumours,rand_normal)]

meta <- colData(data) %>% data.frame %>% 
  select(patient, shortLetterCode) %>% 
  left_join(subtype) %>% 
  select(patient,shortLetterCode,vital_status,age_at_initial_pathologic_diagnosis,BRCA_Subtype_PAM50,pathologic_stage,BRCA_Pathology,days_to_death,days_to_last_followup) %>% left_join(clin)



## find which IDs can be mapped to SYMBOLs

library(org.Hs.eg.db)

df <- data.frame(id = rownames(data)) %>% 
  tidyr::separate(id, into = c("ENSEMBL","Version"),remove = FALSE)

anno <- AnnotationDbi::select(org.Hs.eg.db, 
                              keys = df$ENSEMBL,
                              columns = "SYMBOL",
                              keytype = "ENSEMBL"
                              )

id_to_use <- left_join(df, anno) %>% 
  filter(!is.na(SYMBOL)) %>% 
  pull(id) %>% 
  unique

data <- data[id_to_use,]

counts <- assay(data,"unstranded") %>% data.frame %>% tibble::rownames_to_column("ENSEMBL")

rownames(meta) <- colnames(counts)[-1]
write.table(counts, "brca_example.tsv",sep = "\t")
write.table(meta, "brca_example_meta.tsv", sep = "\t")
```
